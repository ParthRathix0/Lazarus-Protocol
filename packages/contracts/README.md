# Lazarus Protocol: Smart Contracts

This directory contains the core smart contracts for the Lazarus Protocol, built using the **Foundry** development framework.

## Architecture

Lazarus Protocol uses a multi-chain architecture to separate the liveness monitoring from the asset vault. 

### 1. LazarusSource (Source Chain - Sepolia)
The monitor contract. It tracks user activity and holds the rules for when a "liquidation" (evacuation) can occur.
- **Heartbeat Management**: Users "ping" the contract to prove liveness.
- **Deposit/Withdraw**: Users can deposit funds directly into the contract. These funds, along with wallet allowances, are protected.
- **Liquidation**: The authorized **Watchtower** can trigger an evacuation after 7 days of inactivity.
- **Security**: The `liquidate` function performs a heuristic check on the LI.FI calldata to ensure the user's designated beneficiary is included in the instruction, preventing a compromised watchtower from redirecting funds.

### 2. LazarusVault (Destination Chain - Arbitrum Sepolia)
A secure storage contract on a separate network. 
- **Receipt**: Receives incoming USDC from the LI.FI bridge.
- **Permissions**: Tracks independent balances for multiple beneficiaries.
- **Claims**: Only the designated beneficiary can claim assets from the vault.

---

## Technical Specifications

### Cross-Chain Security Heuristic
The `LazarusSource.liquidate` function implements a critical security check:
```solidity
// Heuristic defense: Search for beneficiary address in LI.FI calldata
for (uint256 i = 4; i + 20 <= searchLen; i++) {
    // ... extraction logic ...
    if (extracted == beneficiary) {
        beneficiaryFound = true;
        break;
    }
}
```
This ensures that the bridge instruction generated by the Watchtower actually targets the correct recipient.

### State Transitions
- **Registered**: User has defined a beneficiary.
- **Active**: Last ping < 7 days ago.
- **Inactive/Liquidatable**: Last ping > 7 days ago.
- **Dead**: marked after at least one successful liquidation call.

---

## Development

### Prerequisites
- [Foundry](https://book.getfoundry.sh/getting-started/installation)

### Build
```bash
forge build
```

### Test
```bash
forge test
```

### Deployment
Deployment is handled via Foundry scripts in `script/Deploy.s.sol`.

1. **LazarusSource (Sepolia)**:
```bash
forge script script/Deploy.s.sol:DeployLazarus --rpc-url $SEPOLIA_RPC_URL --broadcast
```

2. **LazarusVault (Arbitrum Sepolia)**:
```bash
forge script script/Deploy.s.sol:DeployVault --rpc-url $ARBITRUM_SEPOLIA_RPC_URL --broadcast
```

---

## Environment Variables
Create a `.env` file based on `.env.example`:
- `PRIVATE_KEY`: Deployer account.
- `SEPOLIA_RPC_URL`: Source chain access.
- `ARBITRUM_SEPOLIA_RPC_URL`: Destination chain access.
- `ETHERSCAN_API_KEY`: For contract verification.
